<script lang="ts">
  import { createEventDispatcher } from 'svelte';
  import { createMapContext } from './context.js';
  import maplibre, { type LngLatBoundsLike, type LngLatLike } from 'maplibre-gl';
  import compare from 'just-compare';
  import 'maplibre-gl/dist/maplibre-gl.css';
  import type { CustomImageSpec } from './types.js';

  export let map: maplibregl.Map | null = null;
  let classNames: string | undefined = undefined;
  export { classNames as class };
  export let center: LngLatLike = [0, 0];
  export let zoom = 1;
  export let bounds: LngLatBoundsLike | undefined = undefined;
  export let loaded = false;
  export let minZoom = 0;
  export let maxZoom = 22;
  export let interactive = true;
  /** Set to true if you want to export the map as an image */
  export let preserveDrawingBuffer = false;
  export let maxBounds: LngLatBoundsLike | undefined = undefined;
  /** Custom images to load into the map. */
  export let images: CustomImageSpec[] = [];

  const dispatch = createEventDispatcher();

  const { map: mapInstance, loadedImages } = createMapContext();
  $: map = $mapInstance;

  let loadingImages = new Set();
  function loadImage(image: CustomImageSpec) {
    if (!$mapInstance?.loaded()) {
      return;
    }

    if ('url' in image) {
      loadingImages.add(image.id);
      $mapInstance.loadImage(image.url, (error, imageData) => {
        loadingImages.delete(image.id);
        if (error) {
          dispatch('error', error);
        } else if (imageData) {
          $mapInstance?.addImage(image.id, imageData, image.options);
          $loadedImages.add(image.id);
          $loadedImages = $loadedImages; // trigger reactivity
        }
      });
    } else {
      $mapInstance.addImage(image.id, image.data, image.options);
      $loadedImages.add(image.id);
      $loadedImages = $loadedImages; // trigger reactivity
    }
  }

  $: if (loaded && $mapInstance?.loaded()) {
    for (let image of images) {
      if (!loadingImages.has(image.id) && !$mapInstance.hasImage(image.id)) {
        loadImage(image);
      }
    }
  }

  $: allImagesLoaded = images.every((image) => $loadedImages.has(image.id));

  function createMap(element: HTMLDivElement) {
    $mapInstance = new maplibre.Map({
      container: element,
      style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
      center,
      zoom,
      minZoom,
      maxZoom,
      interactive,
      preserveDrawingBuffer,
      maxBounds,
      bounds,
    });

    $mapInstance.on('load', (e) => {
      loaded = true;
      dispatch('load', { map: $mapInstance });
    });

    $mapInstance.on('error', (e) => dispatch('error', { ...e, map: $mapInstance }));

    $mapInstance.on('movestart', (ev) => dispatch('movestart', { ...ev, map: $mapInstance }));
    $mapInstance.on('moveend', (ev) => {
      center = ev.target.getCenter();
      zoom = ev.target.getZoom();
      bounds = ev.target.getBounds();
      dispatch('moveend', { ...ev, map: $mapInstance });
    });

    $mapInstance.on('zoomstart', (ev) => dispatch('zoomstart', { ...ev, map: $mapInstance }));
    $mapInstance.on('zoomend', (ev) => {
      zoom = ev.target.getZoom();
      dispatch('zoomend', { ...ev, map: $mapInstance });
    });

    return {
      destroy() {
        loaded = false;
        $mapInstance?.remove();
        $mapInstance = null;
      },
    };
  }

  $: if (center && !compare(center, $mapInstance?.getCenter())) $mapInstance?.panTo(center);
  $: if (zoom && !compare(zoom, $mapInstance?.getZoom())) $mapInstance?.zoomTo(zoom);
  $: if (bounds && !compare(bounds, $mapInstance?.getBounds())) $mapInstance?.fitBounds(bounds);
</script>

<div class={classNames} class:expand-map={!classNames} use:createMap>
  {#if $mapInstance && loaded}
    <slot map={$mapInstance} loadedImages={$loadedImages} {allImagesLoaded} />
  {/if}
</div>

<style>
  .expand-map {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
  }
</style>
